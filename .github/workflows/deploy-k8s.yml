name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - undeploy
        default: 'deploy'
  # Automatic triggers disabled by default for security
  # Uncomment below to enable automatic runs on push
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'k8s/**'
  #     - '.github/workflows/deploy-k8s.yml'

env:
  GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
  GOOGLE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
  GOOGLE_REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  GOOGLE_ZONE: ${{ secrets.GCP_ZONE || 'us-central1-a' }}
  CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME || 'trt-llm-cluster' }}

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy'
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure kubectl
        run: |
          echo "[$(date)] Configuring kubectl for GKE cluster..."
          gcloud container clusters get-credentials \
            ${{ env.CLUSTER_NAME }} \
            --zone ${{ env.GOOGLE_ZONE }} \
            --project ${{ secrets.GCP_PROJECT_ID }}
          echo "[$(date)] kubectl configured successfully"

      - name: Install jq
        run: |
          echo "[$(date)] Installing jq..."
          sudo apt-get update && sudo apt-get install -y jq
          echo "[$(date)] jq installed"

      - name: Verify GPU support
        run: |
          echo "[$(date)] Verifying GPU support in cluster..."
          kubectl get nodes -o json | jq -r '.items[] | select(.status.allocatable."nvidia.com/gpu" != null) | "âœ“ \(.metadata.name): \(.status.allocatable."nvidia.com/gpu") GPU(s)"' || echo "âš  No GPU nodes found"
          echo "[$(date)] GPU verification completed"

      - name: Create namespace
        run: |
          echo "[$(date)] Creating namespace..."
          kubectl apply -f k8s/namespace.yaml
          echo "[$(date)] Namespace created"

      - name: Create ResourceQuota and LimitRange
        run: |
          echo "[$(date)] Creating ResourceQuota and LimitRange..."
          kubectl apply -f k8s/resource-quota.yaml
          kubectl apply -f k8s/limit-range.yaml
          echo "[$(date)] Resource quotas and limits created"

      - name: Create ConfigMap
        run: |
          echo "[$(date)] Creating ConfigMap..."
          kubectl apply -f k8s/configmap.yaml
          echo "[$(date)] ConfigMap created"

      - name: Create PVC
        run: |
          echo "[$(date)] Creating PersistentVolumeClaim..."
          kubectl apply -f k8s/pvc.yaml
          echo "[$(date)] Waiting for PVC to be bound..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if kubectl get pvc model-storage -n triton-inference -o jsonpath='{.status.phase}' 2>/dev/null | grep -q Bound; then
              echo "[$(date)] âœ“ PVC is bound"
              break
            fi
            sleep 5
            elapsed=$((elapsed + 5))
            echo "[$(date)] Waiting for PVC... (${elapsed}s/${timeout}s)"
          done

      - name: Deploy Triton
        run: |
          echo "[$(date)] Deploying Triton Inference Server..."
          kubectl apply -f k8s/deployment.yaml
          echo "[$(date)] Deployment created"

      - name: Create Services
        run: |
          echo "[$(date)] Creating Services..."
          kubectl apply -f k8s/service.yaml
          echo "[$(date)] Services created"

      - name: Create OpenWebUI PVC
        run: |
          echo "[$(date)] Creating OpenWebUI PersistentVolumeClaim..."
          kubectl apply -f k8s/openwebui-pvc.yaml
          echo "[$(date)] Waiting for PVC to be bound..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if kubectl get pvc openwebui-data -n triton-inference -o jsonpath='{.status.phase}' 2>/dev/null | grep -q Bound; then
              echo "[$(date)] âœ“ OpenWebUI PVC is bound"
              break
            fi
            sleep 5
            elapsed=$((elapsed + 5))
          done

      - name: Create OpenWebUI ConfigMap
        run: |
          echo "[$(date)] Creating OpenWebUI ConfigMap..."
          kubectl apply -f k8s/openwebui-configmap.yaml
          echo "[$(date)] OpenWebUI ConfigMap created"

      - name: Deploy OpenWebUI
        run: |
          echo "[$(date)] Deploying OpenWebUI..."
          kubectl apply -f k8s/openwebui-deployment.yaml
          echo "[$(date)] OpenWebUI deployment created"

      - name: Create OpenWebUI Service
        run: |
          echo "[$(date)] Creating OpenWebUI Service..."
          kubectl apply -f k8s/openwebui-service.yaml
          echo "[$(date)] OpenWebUI Service created"

      - name: Create Prometheus PVC
        run: |
          echo "[$(date)] Creating Prometheus PersistentVolumeClaim..."
          kubectl apply -f k8s/prometheus-pvc.yaml
          echo "[$(date)] Waiting for PVC to be bound..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if kubectl get pvc prometheus-storage -n triton-inference -o jsonpath='{.status.phase}' 2>/dev/null | grep -q Bound; then
              echo "[$(date)] âœ“ Prometheus PVC is bound"
              break
            fi
            sleep 5
            elapsed=$((elapsed + 5))
          done

      - name: Create Prometheus ConfigMap
        run: |
          echo "[$(date)] Creating Prometheus ConfigMap..."
          kubectl apply -f k8s/prometheus-configmap.yaml
          echo "[$(date)] Prometheus ConfigMap created"

      - name: Deploy Prometheus
        run: |
          echo "[$(date)] Deploying Prometheus..."
          kubectl apply -f k8s/prometheus-deployment.yaml
          echo "[$(date)] Prometheus deployment created"

      - name: Create Prometheus Service
        run: |
          echo "[$(date)] Creating Prometheus Service..."
          kubectl apply -f k8s/prometheus-service.yaml
          echo "[$(date)] Prometheus Service created"

      - name: Wait for deployment
        run: |
          echo "[$(date)] Waiting for deployment to be ready..."
          kubectl wait --for=condition=available \
            --timeout=600s \
            deployment/triton-qwen3-8b \
            -n triton-inference || echo "âš  Triton deployment not ready within timeout"
          kubectl wait --for=condition=available \
            --timeout=300s \
            deployment/openwebui \
            -n triton-inference || echo "âš  OpenWebUI deployment not ready within timeout"
          kubectl wait --for=condition=available \
            --timeout=300s \
            deployment/prometheus \
            -n triton-inference || echo "âš  Prometheus deployment not ready within timeout"
          echo "[$(date)] Deployment status check completed"

      - name: Get service endpoints
        id: get-endpoints
        run: |
          echo "=========================================="
          echo "[$(date)] Getting service endpoints..."
          echo "=========================================="
          sleep 15  # Wait longer for LoadBalancer IPs to be assigned
          
          # Retry logic for getting IPs
          MAX_RETRIES=12
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            TRITON_IP=$(kubectl get service triton-qwen3-8b -n triton-inference -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            OPENWEBUI_IP=$(kubectl get service openwebui -n triton-inference -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            PROMETHEUS_IP=$(kubectl get service prometheus -n triton-inference -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            
            if [ -n "$TRITON_IP" ] && [ -n "$OPENWEBUI_IP" ] && [ -n "$PROMETHEUS_IP" ]; then
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "[$(date)] Waiting for LoadBalancer IPs... (attempt $RETRY_COUNT/$MAX_RETRIES)"
            sleep 10
          done
          
          # Set defaults if still empty
          TRITON_IP=${TRITON_IP:-"pending"}
          OPENWEBUI_IP=${OPENWEBUI_IP:-"pending"}
          PROMETHEUS_IP=${PROMETHEUS_IP:-"pending"}
          
          echo "triton_ip=$TRITON_IP" >> $GITHUB_OUTPUT
          echo "openwebui_ip=$OPENWEBUI_IP" >> $GITHUB_OUTPUT
          echo "prometheus_ip=$PROMETHEUS_IP" >> $GITHUB_OUTPUT
          
          echo ""
          echo "=========================================="
          echo "SERVICE ENDPOINTS"
          echo "=========================================="
          echo ""
          echo "Triton Inference Server:"
          echo "  HTTP:    http://$TRITON_IP:8000"
          echo "  gRPC:    $TRITON_IP:8001"
          echo "  Metrics: http://$TRITON_IP:8002/metrics"
          echo ""
          echo "OpenWebUI:"
          echo "  Web UI:  http://$OPENWEBUI_IP"
          echo ""
          echo "Prometheus:"
          echo "  Metrics UI: http://$PROMETHEUS_IP:9090"
          echo ""
          echo "=========================================="

      - name: Get pod and service status
        run: |
          echo ""
          echo "=========================================="
          echo "[$(date)] Pod Status"
          echo "=========================================="
          kubectl get pods -n triton-inference
          echo ""
          echo "=========================================="
          echo "[$(date)] Service Status"
          echo "=========================================="
          kubectl get svc -n triton-inference
          echo ""
          echo "=========================================="
          echo "[$(date)] Ingress Status (if deployed)"
          echo "=========================================="
          kubectl get ingress -n triton-inference 2>/dev/null || echo "No ingress resources found"

      - name: Create Summary
        run: |
          echo "## ðŸš€ Kubernetes Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** ${{ env.CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** triton-inference" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Service Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Triton Inference Server" >> $GITHUB_STEP_SUMMARY
          echo "- **HTTP:** \`http://${{ steps.get-endpoints.outputs.triton_ip }}:8000\`" >> $GITHUB_STEP_SUMMARY
          echo "- **gRPC:** \`${{ steps.get-endpoints.outputs.triton_ip }}:8001\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Metrics:** \`http://${{ steps.get-endpoints.outputs.triton_ip }}:8002/metrics\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### OpenWebUI" >> $GITHUB_STEP_SUMMARY
          echo "- **Web UI:** \`http://${{ steps.get-endpoints.outputs.openwebui_ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Prometheus" >> $GITHUB_STEP_SUMMARY
          echo "- **Metrics UI:** \`http://${{ steps.get-endpoints.outputs.prometheus_ip }}:9090\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Upload model files to PVC (see k8s/README.md)" >> $GITHUB_STEP_SUMMARY
          echo "2. Test inference endpoint" >> $GITHUB_STEP_SUMMARY
          echo "3. Access OpenWebUI to interact with the model" >> $GITHUB_STEP_SUMMARY
          echo "4. View metrics in Prometheus" >> $GITHUB_STEP_SUMMARY

  undeploy:
    name: Undeploy from Kubernetes
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'undeploy'
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure kubectl
        run: |
          echo "[$(date)] Configuring kubectl for GKE cluster..."
          gcloud container clusters get-credentials \
            ${{ env.CLUSTER_NAME }} \
            --zone ${{ env.GOOGLE_ZONE }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Undeploy resources
        run: |
          echo "[$(date)] Undeploying Kubernetes resources..."
          # Delete services
          kubectl delete -f k8s/prometheus-service.yaml --ignore-not-found=true
          kubectl delete -f k8s/openwebui-service.yaml --ignore-not-found=true
          kubectl delete -f k8s/service.yaml --ignore-not-found=true
          # Delete deployments
          kubectl delete -f k8s/prometheus-deployment.yaml --ignore-not-found=true
          kubectl delete -f k8s/openwebui-deployment.yaml --ignore-not-found=true
          kubectl delete -f k8s/deployment.yaml --ignore-not-found=true
          # Delete PVCs
          kubectl delete -f k8s/prometheus-pvc.yaml --ignore-not-found=true
          kubectl delete -f k8s/openwebui-pvc.yaml --ignore-not-found=true
          kubectl delete -f k8s/pvc.yaml --ignore-not-found=true
          # Delete ConfigMaps
          kubectl delete -f k8s/prometheus-configmap.yaml --ignore-not-found=true
          kubectl delete -f k8s/openwebui-configmap.yaml --ignore-not-found=true
          kubectl delete -f k8s/configmap.yaml --ignore-not-found=true
          # Delete ResourceQuota and LimitRange
          kubectl delete -f k8s/resource-quota.yaml --ignore-not-found=true
          kubectl delete -f k8s/limit-range.yaml --ignore-not-found=true
          # Delete namespace (this will delete any remaining resources)
          kubectl delete -f k8s/namespace.yaml --ignore-not-found=true
          echo "[$(date)] Undeployment completed"

      - name: Create Summary
        run: |
          echo "## ðŸ—‘ï¸ Kubernetes Resources Removed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Triton resources have been removed from the cluster." >> $GITHUB_STEP_SUMMARY

