name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - undeploy
        default: 'deploy'
  # Automatic triggers disabled by default for security
  # Uncomment below to enable automatic runs on push
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'k8s/**'
  #     - '.github/workflows/deploy-k8s.yml'

env:
  GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
  GOOGLE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
  GOOGLE_REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  GOOGLE_ZONE: ${{ secrets.GCP_ZONE || 'us-central1-a' }}
  CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME || 'trt-llm-cluster' }}

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy'
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure kubectl
        run: |
          echo "[$(date)] Configuring kubectl for GKE cluster..."
          gcloud container clusters get-credentials \
            ${{ env.CLUSTER_NAME }} \
            --zone ${{ env.GOOGLE_ZONE }} \
            --project ${{ secrets.GCP_PROJECT_ID }}
          echo "[$(date)] kubectl configured successfully"

      - name: Install Helm
        run: |
          echo "[$(date)] Installing Helm..."
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version
          echo "[$(date)] Helm installed"

      - name: Install jq
        run: |
          echo "[$(date)] Installing jq..."
          sudo apt-get update && sudo apt-get install -y jq
          echo "[$(date)] jq installed"

      - name: Verify GPU support
        run: |
          echo "[$(date)] Verifying GPU support in cluster..."
          kubectl get nodes -o json | jq -r '.items[] | select(.status.allocatable."nvidia.com/gpu" != null) | "âœ“ \(.metadata.name): \(.status.allocatable."nvidia.com/gpu") GPU(s)"' || echo "âš  No GPU nodes found"
          echo "[$(date)] GPU verification completed"

      - name: Deploy with Helm
        run: |
          echo "[$(date)] Deploying with Helm..."
          helm upgrade --install qwen3-8b-triton ./helm/qwen3-8b-triton \
            --namespace triton-inference \
            --create-namespace \
            --wait \
            --timeout 10m \
            --set triton.enabled=true \
            --set openwebui.enabled=true \
            --set prometheus.enabled=true
          echo "[$(date)] Helm deployment completed"

      - name: Verify deployment status
        run: |
          echo "[$(date)] Verifying deployment status..."
          kubectl get deployments -n triton-inference
          kubectl get pods -n triton-inference
          echo "[$(date)] Deployment verification completed"

      - name: Get service endpoints
        id: get-endpoints
        run: |
          echo "=========================================="
          echo "[$(date)] Getting service endpoints..."
          echo "=========================================="
          sleep 15  # Wait longer for LoadBalancer IPs to be assigned
          
          # Retry logic for getting IPs
          MAX_RETRIES=12
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            TRITON_IP=$(kubectl get service triton-qwen3-8b -n triton-inference -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            OPENWEBUI_IP=$(kubectl get service openwebui -n triton-inference -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            PROMETHEUS_IP=$(kubectl get service prometheus -n triton-inference -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            
            if [ -n "$TRITON_IP" ] && [ -n "$OPENWEBUI_IP" ] && [ -n "$PROMETHEUS_IP" ]; then
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "[$(date)] Waiting for LoadBalancer IPs... (attempt $RETRY_COUNT/$MAX_RETRIES)"
            sleep 10
          done
          
          # Set defaults if still empty
          TRITON_IP=${TRITON_IP:-"pending"}
          OPENWEBUI_IP=${OPENWEBUI_IP:-"pending"}
          PROMETHEUS_IP=${PROMETHEUS_IP:-"pending"}
          
          echo "triton_ip=$TRITON_IP" >> $GITHUB_OUTPUT
          echo "openwebui_ip=$OPENWEBUI_IP" >> $GITHUB_OUTPUT
          echo "prometheus_ip=$PROMETHEUS_IP" >> $GITHUB_OUTPUT
          
          echo ""
          echo "=========================================="
          echo "SERVICE ENDPOINTS"
          echo "=========================================="
          echo ""
          echo "Triton Inference Server:"
          echo "  HTTP:    http://$TRITON_IP:8000"
          echo "  gRPC:    $TRITON_IP:8001"
          echo "  Metrics: http://$TRITON_IP:8002/metrics"
          echo ""
          echo "OpenWebUI:"
          echo "  Web UI:  http://$OPENWEBUI_IP"
          echo ""
          echo "Prometheus:"
          echo "  Metrics UI: http://$PROMETHEUS_IP:9090"
          echo ""
          echo "=========================================="

      - name: Get pod and service status
        run: |
          echo ""
          echo "=========================================="
          echo "[$(date)] Pod Status"
          echo "=========================================="
          kubectl get pods -n triton-inference
          echo ""
          echo "=========================================="
          echo "[$(date)] Service Status"
          echo "=========================================="
          kubectl get svc -n triton-inference
          echo ""
          echo "=========================================="
          echo "[$(date)] Ingress Status (if deployed)"
          echo "=========================================="
          kubectl get ingress -n triton-inference 2>/dev/null || echo "No ingress resources found"

      - name: Create Summary
        run: |
          echo "## ðŸš€ Kubernetes Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** ${{ env.CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** triton-inference" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Service Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Triton Inference Server" >> $GITHUB_STEP_SUMMARY
          echo "- **HTTP:** \`http://${{ steps.get-endpoints.outputs.triton_ip }}:8000\`" >> $GITHUB_STEP_SUMMARY
          echo "- **gRPC:** \`${{ steps.get-endpoints.outputs.triton_ip }}:8001\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Metrics:** \`http://${{ steps.get-endpoints.outputs.triton_ip }}:8002/metrics\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### OpenWebUI" >> $GITHUB_STEP_SUMMARY
          echo "- **Web UI:** \`http://${{ steps.get-endpoints.outputs.openwebui_ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Prometheus" >> $GITHUB_STEP_SUMMARY
          echo "- **Metrics UI:** \`http://${{ steps.get-endpoints.outputs.prometheus_ip }}:9090\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Upload model files to PVC (see helm/qwen3-8b-triton/README.md)" >> $GITHUB_STEP_SUMMARY
          echo "2. Test inference endpoint" >> $GITHUB_STEP_SUMMARY
          echo "3. Access OpenWebUI to interact with the model" >> $GITHUB_STEP_SUMMARY
          echo "4. View metrics in Prometheus" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Helm Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Upgrade deployment" >> $GITHUB_STEP_SUMMARY
          echo "helm upgrade qwen3-8b-triton ./helm/qwen3-8b-triton -n triton-inference" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View values" >> $GITHUB_STEP_SUMMARY
          echo "helm get values qwen3-8b-triton -n triton-inference" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Uninstall" >> $GITHUB_STEP_SUMMARY
          echo "helm uninstall qwen3-8b-triton -n triton-inference" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  undeploy:
    name: Undeploy from Kubernetes
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'undeploy'
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure kubectl
        run: |
          echo "[$(date)] Configuring kubectl for GKE cluster..."
          gcloud container clusters get-credentials \
            ${{ env.CLUSTER_NAME }} \
            --zone ${{ env.GOOGLE_ZONE }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Install Helm
        run: |
          echo "[$(date)] Installing Helm..."
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version
          echo "[$(date)] Helm installed"

      - name: Undeploy with Helm
        run: |
          echo "[$(date)] Undeploying with Helm..."
          helm uninstall qwen3-8b-triton --namespace triton-inference || echo "âš  Release not found, may already be deleted"
          echo "[$(date)] Helm undeployment completed"
          
          # Optionally delete namespace if empty
          echo "[$(date)] Checking if namespace should be deleted..."
          if kubectl get namespace triton-inference 2>/dev/null; then
            kubectl delete namespace triton-inference --ignore-not-found=true || echo "âš  Namespace deletion failed or still contains resources"
          fi
          echo "[$(date)] Undeployment completed"

      - name: Create Summary
        run: |
          echo "## ðŸ—‘ï¸ Kubernetes Resources Removed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Triton resources have been removed from the cluster." >> $GITHUB_STEP_SUMMARY

