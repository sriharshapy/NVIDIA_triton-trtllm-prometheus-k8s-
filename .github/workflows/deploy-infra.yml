name: Deploy GCP Infrastructure

on:
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'Deployment type'
        required: true
        type: choice
        options:
          - vm
          - gke
        default: 'gke'
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: 'plan'
  # Automatic triggers disabled by default for security
  # Uncomment below to enable automatic runs on push/PR
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'terraform/**'
  #     - '.github/workflows/deploy-infra.yml'
  # pull_request:
  #   branches:
  #     - main
  #   paths:
  #     - 'terraform/**'
  #     - '.github/workflows/deploy-infra.yml'

env:
  GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
  GOOGLE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
  GOOGLE_REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  GOOGLE_ZONE: ${{ secrets.GCP_ZONE || 'us-central1-a' }}

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Init - VM
        if: github.event.inputs.deployment_type == 'vm'
        working-directory: terraform
        run: |
          echo "[$(date)] Initializing Terraform for VM deployment..."
          terraform init -input=false
          echo "[$(date)] Terraform initialization completed"

      - name: Terraform Plan - VM
        if: github.event.inputs.deployment_type == 'vm'
        working-directory: terraform
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ secrets.GCP_REGION || 'us-central1' }}
          TF_VAR_zone: ${{ secrets.GCP_ZONE || 'us-central1-a' }}
        run: |
          echo "[$(date)] Running Terraform plan for VM deployment..."
          terraform plan -input=false -out=tfplan
          echo "[$(date)] Terraform plan completed"

      - name: Terraform Init - GKE
        if: github.event.inputs.deployment_type == 'gke'
        working-directory: terraform/gke
        run: |
          echo "[$(date)] Initializing Terraform for GKE deployment..."
          terraform init -input=false
          echo "[$(date)] Terraform initialization completed"

      - name: Terraform Plan - GKE
        if: github.event.inputs.deployment_type == 'gke'
        working-directory: terraform/gke
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ secrets.GCP_REGION || 'us-central1' }}
          TF_VAR_zone: ${{ secrets.GCP_ZONE || 'us-central1-a' }}
          TF_VAR_cluster_name: ${{ secrets.GKE_CLUSTER_NAME || 'trt-llm-cluster' }}
        run: |
          echo "[$(date)] Running Terraform plan for GKE deployment..."
          terraform plan -input=false -out=tfplan
          echo "[$(date)] Terraform plan completed"

      # PR comment step disabled (automatic triggers disabled)
      # - name: Comment PR
      #   if: github.event_name == 'pull_request'
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       const output = `#### Terraform Plan ðŸ¤–
      #       *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*
      #       
      #       Terraform plan completed successfully for **${{ github.event.inputs.deployment_type || 'gke' }}** deployment.
      #       
      #       <details><summary>Show Plan</summary>
      #       
      #       \`\`\`
      #       Plan completed - check logs for details
      #       \`\`\`
      #       
      #       </details>
      #       
      #       *Workflow: \`${{ github.workflow }}\`*`;
      #       github.rest.issues.createComment({
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: output
      #       })

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    # Removed needs: terraform-plan - apply can run independently
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
    environment:
      name: production
      url: ${{ steps.get-outputs.outputs.instance_ip || steps.get-gke-outputs.outputs.cluster_endpoint }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Apply - VM
        if: github.event.inputs.deployment_type == 'vm'
        working-directory: terraform
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ secrets.GCP_REGION || 'us-central1' }}
          TF_VAR_zone: ${{ secrets.GCP_ZONE || 'us-central1-a' }}
        run: |
          echo "[$(date)] Applying Terraform configuration for VM..."
          terraform init -input=false
          terraform apply -input=false -auto-approve
          echo "[$(date)] Terraform apply completed"

      - name: Get VM Outputs
        if: github.event.inputs.deployment_type == 'vm'
        id: get-outputs
        working-directory: terraform
        run: |
          INSTANCE_IP=$(terraform output -raw instance_ip)
          INSTANCE_ZONE=$(terraform output -raw instance_zone)
          INSTANCE_NAME=$(terraform output -raw instance_name)
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
          echo "instance_zone=$INSTANCE_ZONE" >> $GITHUB_OUTPUT
          echo "instance_name=$INSTANCE_NAME" >> $GITHUB_OUTPUT
          echo "[$(date)] Instance Name: $INSTANCE_NAME"
          echo "[$(date)] Instance IP: $INSTANCE_IP"
          echo "[$(date)] Instance Zone: $INSTANCE_ZONE"

      - name: Terraform Apply - GKE
        if: github.event.inputs.deployment_type == 'gke'
        working-directory: terraform/gke
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ secrets.GCP_REGION || 'us-central1' }}
          TF_VAR_zone: ${{ secrets.GCP_ZONE || 'us-central1-a' }}
          TF_VAR_cluster_name: ${{ secrets.GKE_CLUSTER_NAME || 'trt-llm-cluster' }}
        run: |
          echo "[$(date)] Applying Terraform configuration for GKE..."
          terraform init -input=false
          
          # Refresh state to sync with actual GCP resources
          echo "[$(date)] Refreshing Terraform state..."
          terraform refresh -input=false || true
          
          # Auto-import existing resources if they exist in GCP but not in Terraform state
          echo "[$(date)] Checking for existing resources to auto-import..."
          CLUSTER_NAME="${{ secrets.GKE_CLUSTER_NAME || 'trt-llm-cluster' }}"
          ZONE="${{ secrets.GCP_ZONE || 'us-central1-a' }}"
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
          
          # Check and import cluster
          if gcloud container clusters describe ${CLUSTER_NAME} --zone=${ZONE} --project=${PROJECT_ID} --format='value(name)' 2>/dev/null | grep -q "${CLUSTER_NAME}"; then
            echo "[$(date)] GKE Cluster exists in GCP, attempting to import..."
            terraform import google_container_cluster.trt_llm_cluster "projects/${PROJECT_ID}/locations/${ZONE}/clusters/${CLUSTER_NAME}" 2>/dev/null && \
              echo "[$(date)] âœ“ Successfully imported GKE Cluster" || \
              echo "[$(date)] â„¹ Cluster already in Terraform state"
          fi
          
          # Check and import service account
          if gcloud iam service-accounts describe gke-trillm-sa@${PROJECT_ID}.iam.gserviceaccount.com --project=${PROJECT_ID} --format='value(email)' 2>/dev/null | grep -q "@"; then
            echo "[$(date)] Service Account exists in GCP, attempting to import..."
            terraform import google_service_account.gke_sa "projects/${PROJECT_ID}/serviceAccounts/gke-trillm-sa@${PROJECT_ID}.iam.gserviceaccount.com" 2>/dev/null && \
              echo "[$(date)] âœ“ Successfully imported Service Account" || \
              echo "[$(date)] â„¹ Service Account already in Terraform state"
          fi
          
          # Check and import node pools (only if cluster exists)
          if gcloud container clusters describe ${CLUSTER_NAME} --zone=${ZONE} --project=${PROJECT_ID} --format='value(name)' 2>/dev/null | grep -q "${CLUSTER_NAME}"; then
            # Import A100 node pool
            if gcloud container node-pools describe a100-node-pool --cluster=${CLUSTER_NAME} --zone=${ZONE} --project=${PROJECT_ID} --format='value(name)' 2>/dev/null | grep -q "a100-node-pool"; then
              echo "[$(date)] A100 Node Pool exists in GCP, attempting to import..."
              terraform import google_container_node_pool.a100_pool "projects/${PROJECT_ID}/locations/${ZONE}/clusters/${CLUSTER_NAME}/nodePools/a100-node-pool" 2>/dev/null && \
                echo "[$(date)] âœ“ Successfully imported A100 Node Pool" || \
                echo "[$(date)] â„¹ A100 Node Pool already in Terraform state"
            fi
            
            # Import CPU node pool
            if gcloud container node-pools describe cpu-node-pool --cluster=${CLUSTER_NAME} --zone=${ZONE} --project=${PROJECT_ID} --format='value(name)' 2>/dev/null | grep -q "cpu-node-pool"; then
              echo "[$(date)] CPU Node Pool exists in GCP, attempting to import..."
              terraform import google_container_node_pool.cpu_pool "projects/${PROJECT_ID}/locations/${ZONE}/clusters/${CLUSTER_NAME}/nodePools/cpu-node-pool" 2>/dev/null && \
                echo "[$(date)] âœ“ Successfully imported CPU Node Pool" || \
                echo "[$(date)] â„¹ CPU Node Pool already in Terraform state"
            fi
          fi
          
          echo "[$(date)] Auto-import check completed"
          
          echo "[$(date)] Running Terraform apply..."
          terraform apply -input=false -auto-approve
          echo "[$(date)] Terraform apply completed"

      - name: Get GKE Outputs
        if: github.event.inputs.deployment_type == 'gke'
        id: get-gke-outputs
        working-directory: terraform/gke
        run: |
          CLUSTER_NAME=$(terraform output -raw cluster_name)
          CLUSTER_ENDPOINT=$(terraform output -raw cluster_endpoint)
          CLUSTER_LOCATION=$(terraform output -raw cluster_location)
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "cluster_endpoint=$CLUSTER_ENDPOINT" >> $GITHUB_OUTPUT
          echo "cluster_location=$CLUSTER_LOCATION" >> $GITHUB_OUTPUT
          echo "[$(date)] Cluster Name: $CLUSTER_NAME"
          echo "[$(date)] Cluster Endpoint: $CLUSTER_ENDPOINT"
          echo "[$(date)] Cluster Location: $CLUSTER_LOCATION"

      - name: Configure kubectl for GKE
        if: github.event.inputs.deployment_type == 'gke'
        run: |
          echo "[$(date)] Configuring kubectl for GKE cluster..."
          gcloud container clusters get-credentials \
            ${{ steps.get-gke-outputs.outputs.cluster_name }} \
            --zone ${{ steps.get-gke-outputs.outputs.cluster_location }} \
            --project ${{ secrets.GCP_PROJECT_ID }}
          echo "[$(date)] kubectl configured successfully"

      - name: Create Summary
        run: |
          echo "## ðŸš€ Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.deployment_type }}" == "vm" ]; then
            echo "**Deployment Type:** VM (Compute Engine)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Instance Details" >> $GITHUB_STEP_SUMMARY
            echo "- **Instance IP:** \`${{ steps.get-outputs.outputs.instance_ip }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Instance Zone:** \`${{ steps.get-outputs.outputs.instance_zone }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Access" >> $GITHUB_STEP_SUMMARY
            echo "- **SSH:** \`gcloud compute ssh ${{ steps.get-outputs.outputs.instance_name }} --zone=${{ steps.get-outputs.outputs.instance_zone }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Triton HTTP:** \`http://${{ steps.get-outputs.outputs.instance_ip }}:8000\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Triton gRPC:** \`${{ steps.get-outputs.outputs.instance_ip }}:8001\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Triton Metrics:** \`http://${{ steps.get-outputs.outputs.instance_ip }}:8002/metrics\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Upload model files to the instance" >> $GITHUB_STEP_SUMMARY
            echo "2. SSH to the instance and start Triton server" >> $GITHUB_STEP_SUMMARY
            echo "3. Test inference endpoint" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Deployment Type:** GKE (Kubernetes)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Cluster Details" >> $GITHUB_STEP_SUMMARY
            echo "- **Cluster Name:** \`${{ steps.get-gke-outputs.outputs.cluster_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Cluster Endpoint:** \`${{ steps.get-gke-outputs.outputs.cluster_endpoint }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Cluster Location:** \`${{ steps.get-gke-outputs.outputs.cluster_location }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Get Credentials" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "gcloud container clusters get-credentials ${{ steps.get-gke-outputs.outputs.cluster_name }} \\" >> $GITHUB_STEP_SUMMARY
            echo "  --zone ${{ steps.get-gke-outputs.outputs.cluster_location }} \\" >> $GITHUB_STEP_SUMMARY
            echo "  --project ${{ secrets.GCP_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Run **Deploy to Kubernetes** workflow to deploy services" >> $GITHUB_STEP_SUMMARY
            echo "2. Service endpoints will be displayed after deployment" >> $GITHUB_STEP_SUMMARY
            echo "3. Upload model files to PVC" >> $GITHUB_STEP_SUMMARY
            echo "4. Test inference endpoint" >> $GITHUB_STEP_SUMMARY
          fi

  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Destroy - VM
        if: github.event.inputs.deployment_type == 'vm'
        working-directory: terraform
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ secrets.GCP_REGION || 'us-central1' }}
          TF_VAR_zone: ${{ secrets.GCP_ZONE || 'us-central1-a' }}
        run: |
          echo "[$(date)] Destroying VM infrastructure..."
          terraform init -input=false
          terraform destroy -input=false -auto-approve
          echo "[$(date)] VM infrastructure destroyed"

      - name: Terraform Destroy - GKE
        if: github.event.inputs.deployment_type == 'gke'
        working-directory: terraform/gke
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ secrets.GCP_REGION || 'us-central1' }}
          TF_VAR_zone: ${{ secrets.GCP_ZONE || 'us-central1-a' }}
          TF_VAR_cluster_name: ${{ secrets.GKE_CLUSTER_NAME || 'trt-llm-cluster' }}
        run: |
          echo "[$(date)] Destroying GKE infrastructure..."
          terraform init -input=false
          
          # Refresh state to ensure we have the latest resource state
          echo "[$(date)] Refreshing Terraform state..."
          terraform refresh -input=false || echo "âš  State refresh had issues, continuing with destroy"
          
          # Show what will be destroyed
          echo "[$(date)] Planning destroy operation..."
          terraform plan -destroy -input=false -out=tfplan-destroy || echo "âš  Plan had issues, continuing with destroy"
          
          # Destroy resources
          echo "[$(date)] Executing Terraform destroy..."
          terraform destroy -input=false -auto-approve
          
          # Verify destruction
          echo "[$(date)] Verifying resources are destroyed..."
          CLUSTER_NAME="${{ secrets.GKE_CLUSTER_NAME || 'trt-llm-cluster' }}"
          ZONE="${{ secrets.GCP_ZONE || 'us-central1-a' }}"
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
          
          if gcloud container clusters describe ${CLUSTER_NAME} --zone=${ZONE} --project=${PROJECT_ID} 2>/dev/null; then
            echo "âš  WARNING: Cluster still exists after destroy. Attempting manual cleanup..."
            
            # First, try to get kubectl credentials to clean up Kubernetes resources
            echo "[$(date)] Attempting to clean up Kubernetes resources..."
            if gcloud container clusters get-credentials ${CLUSTER_NAME} --zone=${ZONE} --project=${PROJECT_ID} 2>/dev/null; then
              # Delete all resources in triton-inference namespace
              kubectl delete namespace triton-inference --ignore-not-found=true --timeout=60s 2>/dev/null || true
              # Delete any remaining resources
              kubectl delete all --all --all-namespaces --timeout=30s 2>/dev/null || true
              echo "[$(date)] Kubernetes resources cleanup attempted"
            fi
            
            # Delete node pools using async deletion (non-blocking)
            echo "[$(date)] Starting node pool deletion (async)..."
            
            # A100 node pool - start deletion in background
            if gcloud container node-pools describe a100-node-pool --cluster=${CLUSTER_NAME} --zone=${ZONE} --project=${PROJECT_ID} 2>/dev/null; then
              echo "[$(date)] Initiating deletion of a100-node-pool..."
              (timeout 60 gcloud container node-pools delete a100-node-pool \
                --cluster=${CLUSTER_NAME} \
                --zone=${ZONE} \
                --project=${PROJECT_ID} \
                --quiet \
                --async 2>&1 && echo "[$(date)] âœ“ a100-node-pool deletion initiated") || \
              echo "âš  a100-node-pool deletion command failed or timed out"
            fi
            
            # CPU node pool - start deletion in background
            if gcloud container node-pools describe cpu-node-pool --cluster=${CLUSTER_NAME} --zone=${ZONE} --project=${PROJECT_ID} 2>/dev/null; then
              echo "[$(date)] Initiating deletion of cpu-node-pool..."
              (timeout 60 gcloud container node-pools delete cpu-node-pool \
                --cluster=${CLUSTER_NAME} \
                --zone=${ZONE} \
                --project=${PROJECT_ID} \
                --quiet \
                --async 2>&1 && echo "[$(date)] âœ“ cpu-node-pool deletion initiated") || \
              echo "âš  cpu-node-pool deletion command failed or timed out"
            fi
            
            # Wait a bit for node pools to start deleting
            echo "[$(date)] Waiting 30 seconds for node pool deletions to initialize..."
            sleep 30
            
            # Delete cluster using async deletion (non-blocking)
            echo "[$(date)] Initiating cluster deletion (async)..."
            (timeout 60 gcloud container clusters delete ${CLUSTER_NAME} \
              --zone=${ZONE} \
              --project=${PROJECT_ID} \
              --quiet \
              --async 2>&1 && echo "[$(date)] âœ“ Cluster deletion initiated") || \
            echo "âš  Cluster deletion command failed or timed out"
            
            echo "[$(date)] Manual cleanup commands executed"
            echo "âš  Note: Deletion is running asynchronously. Cluster deletion may take 5-10 minutes."
            echo "âš  Check GCP Console or run: gcloud container clusters list --zone=${ZONE} --project=${PROJECT_ID}"
          else
            echo "[$(date)] âœ“ Cluster successfully destroyed"
          fi
          
          echo "[$(date)] GKE infrastructure destroy completed"

      - name: Create Summary
        run: |
          echo "## ðŸ—‘ï¸ Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Type:** ${{ github.event.inputs.deployment_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** All resources have been destroyed" >> $GITHUB_STEP_SUMMARY

